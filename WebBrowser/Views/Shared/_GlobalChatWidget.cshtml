<div id="chat-widget">
    <button id="toggle-chat">💬</button>

    <div id="user-list-panel">
        <header>
            <div>
                <button id="tab-users" class="tab-button active">Người dùng</button>
                <button id="tab-groups" class="tab-button">Nhóm</button>
            </div>
            <button id="close-list">×</button>
        </header>

        <div id="users-content">
            <ul id="userList"></ul>
        </div>

        <div id="groups-content" style="display:none;">
            <button id="toggle-group-options" style="margin-bottom:12px;">Ẩn/Hiện tùy chọn nhóm</button>

            <div id="group-options">
                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <input id="add-user-to-group" type="text" placeholder="Nhập tên người dùng...">
                    <button id="add-user-btn">Thêm</button>
                </div>
                //sadsadsa
                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <input id="create-group-name" type="text" placeholder="Nhập tên nhóm...">
                    <button id="create-group-btn">Tạo nhóm</button>
                </div>

                <button id="show-members-btn">Danh sách thành viên</button>
            </div>

            <ul id="groupList"></ul>
            <ul id="groupMembersList"></ul>
        </div>
    </div>
</div>

<style>
    /* ===== Layout cơ bản ===== */
    #chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999
    }

    #toggle-chat {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #007bff;
        color: #fff;
        border: none;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,.2);
        transition: transform .2s,background .2s
    }

        #toggle-chat:hover {
            transform: scale(1.1);
            background: #0056b3
        }

    #user-list-panel {
        display: none;
        width: 280px;
        height: 450px;
        background: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,.15);
        position: fixed;
        bottom: 90px;
        right: 20px;
        overflow: hidden
    }

        #user-list-panel header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #007bff;
            color: #fff;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px
        }

    .tab-button {
        padding: 8px 12px;
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        border-bottom: 2px solid transparent
    }

        .tab-button.active {
            font-weight: 700;
            border-bottom-color: #fff
        }

        .tab-button:hover {
            border-bottom-color: rgba(255,255,255,.5)
        }

    #close-list {
        background: none;
        border: none;
        color: #fff;
        font-size: 18px;
        cursor: pointer
    }

    #users-content, #groups-content {
        padding: 12px;
        overflow-y: auto;
        height: 378px
    }

        #users-content ul, #groups-content ul {
            list-style: none;
            margin: 0;
            padding: 0
        }

        #users-content li, #groups-content li {
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background .2s
        }

            #users-content li:hover, #groups-content li:hover {
                background: #e9ecef
            }

            #users-content li.header, #groups-content li.header {
                font-weight: 700;
                cursor: default
            }

    .unread-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        background: #dc3545;
        color: #fff;
        border-radius: 50%;
        font-size: 12px;
        font-weight: 700
    }

    #add-user-to-group, #create-group-name {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        outline: none;
        font-size: 14px
    }

    #add-user-btn, #create-group-btn, #toggle-group-options {
        padding: 8px 12px;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px
    }

        #add-user-btn:hover, #create-group-btn:hover, #toggle-group-options:hover {
            background: #0056b3
        }

    #show-members-btn {
        padding: 8px 12px;
        background: #28a745;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 12px;
        display: none
    }

        #show-members-btn:hover {
            background: #218838
        }

    #groupMembersList li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-radius: 5px
    }

        #groupMembersList li button {
            padding: 4px 8px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer
        }

            #groupMembersList li button:hover {
                background: #c82333
            }

    #group-options {
        display: block
    }

    /* ===== Cửa sổ chat ===== */
    .chat-window {
        position: fixed;
        bottom: 80px;
        width: 300px;
        height: 360px;
        max-width: 100%;
        box-sizing: border-box;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,.15);
        display: grid;
        grid-template-rows: auto 1fr auto;
        overflow: hidden
    }

        .chat-window.min {
            height: 40px !important
        }

    .chat-header {
        padding: 12px;
        background: #007bff;
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center
    }

        .chat-header span {
            font-weight: 700
        }

        .chat-header button {
            background: none;
            border: none;
            color: #fff;
            font-size: 16px;
            cursor: pointer
        }

    .chat-box {
        min-height: 0;
        overflow-y: auto;
        padding: 12px;
        background: #f8f9fa;
        display: block
    }

    /* ===== Tin nhắn ===== */
    .chat-message {
        margin: 0 0 10px 0;
        display: flex;
        flex-direction: column
    }

        .chat-message.sent {
            align-items: flex-end
        }

        .chat-message.received {
            align-items: flex-start
        }

    /* hàng hiển thị 1 block (bubble/attach) + nút ⋯ kế bên */
    .message-row {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        max-width: 100%
    }

    .chat-message.sent .message-row {
        justify-content: flex-end
    }

    .chat-message.received .message-row {
        justify-content: flex-start
    }

    .message-content {
        max-width: 70%;
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.45;
        word-wrap: break-word;
        white-space: pre-wrap;
        box-shadow: 0 1px 2px rgba(0,0,0,.06)
    }

    .chat-message.sent .message-content {
        background: #007bff;
        color: #fff;
        border-bottom-right-radius: 4px
    }

    .chat-message.received .message-content {
        background: #e9ecef;
        color: #333;
        border-bottom-left-radius: 4px
    }

    .timestamp {
        font-size: 12px;
        color: #68707a;
        margin-top: 4px
    }

    /* ===== File đính kèm ===== */
    .attach {
        max-width: 70%;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        position: relative;
        transition: background .2s,transform .2s;
        box-shadow: 0 1px 2px rgba(0,0,0,.06)
    }

        .attach:hover {
            background: #f8fafc;
            transform: translateY(-1px)
        }

        .attach .icon {
            font-size: 20px;
            color: #4b5563
        }

        .attach .meta {
            font-size: 13px;
            color: #1f2937;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1
        }

        .attach img {
            max-width: 100%;
            border-radius: 8px;
            display: block
        }

        .attach audio, .attach video {
            width: 100%;
            outline: none;
            border-radius: 8px;
            background: #000
        }

    /* ===== Nút ⋯ (đen) nằm BÊN CẠNH ===== */
    .options-outer {
        width: 24px;
        height: 24px;
        flex: 0 0 24px;
        display: flex;
        align-items: center;
        justify-content: center
    }

    .options-btn {
        background: #000;
        color: #fff;
        border: none;
        cursor: pointer;
        width: 24px;

        height: 24px;
        border-radius: 999px;
        font-size: 16px;
        line-height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0,0,0,.2);
        transition: transform .1s ease-in-out,opacity .15s
    }

        .options-btn:hover {
            transform: scale(1.05);
            opacity: .95
        }

    /* ===== Side panel (khung nhỏ) ===== */
    .sidepanel {
        position: absolute;
        z-index: 99999;
        width: 200px;
        background: #fff;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        box-shadow: 0 12px 24px rgba(15,23,42,.10),0 4px 8px rgba(15,23,42,.06);
        padding: 6px 0;
        opacity: 0;
        transform: translateY(-4px);
        transition: opacity .12s ease,transform .12s ease
    }

        .sidepanel.show {
            opacity: 1;
            transform: translateY(0)
        }

        .sidepanel ul {
            list-style: none;
            margin: 0;
            padding: 0
        }

        .sidepanel li {
            padding: 9px 12px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            gap: 8px;
            align-items: center
        }

            .sidepanel li:hover {
                background: #f3f4f6
            }

            .sidepanel li .i {
                width: 18px;
                text-align: center;
                opacity: .85
            }

        .sidepanel::after {
            content: "";
            position: absolute;
            top: 10px;
            width: 10px;
            height: 10px;
            background: #fff;
            border: 1px solid #d1d5db;
            transform: rotate(45deg)
        }

        .sidepanel.right::after {
            left: -6px;
            border-right: none;
            border-top: none;
            box-shadow: -1px -1px 0 #d1d5db
        }

        .sidepanel.left::after {
            right: -6px;
            border-left: none;
            border-bottom: none;
            box-shadow: 1px 1px 0 #d1d5db
        }

    /* ===== Footer ===== */
    .chat-footer {
        border-top: 1px solid #e5e7eb;
        background: #fff;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px
    }

    .chip-row {
        display: none;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        max-height: 96px;
        overflow-y: auto;
        padding-right: 4px
    }

    .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 14px;
        padding: 4px 8px;
        max-width: 100%;
        transition: background .2s
    }

        .chip:hover {
            background: #e2e8f0
        }

        .chip .icon {
            font-size: 16px;
            color: #4b5563
        }

        .chip img {
            height: 24px;
            width: 24px;
            object-fit: cover;
            border-radius: 4px
        }

        .chip .name {
            font-size: 12px;
            color: #1f2937;
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .chip .remove {
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            font-size: 14px
        }

            .chip .remove:hover {
                color: #ef4444
            }

    .controls-row {
        display: flex;
        gap: 6px;
        align-items: center
    }

        .controls-row input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px
        }

        .controls-row button {
            padding: 8px 12px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px
        }

            .controls-row button:hover {
                background: #0056b3
            }

    .attach-btn {
        width: 40px
    }
    
    .sidepanel li.disabled {
        opacity: .5;
        cursor: not-allowed;
    }

        .sidepanel li.disabled:hover {
            background: transparent;
        }


</style>

<script>
    (() => {
      if (window.__chatWidgetLoaded) return; window.__chatWidgetLoaded = true;

      /* ======= State ======= */
      let currentUser='@ViewBag.Username' || 'anonymous';
      let connection, connectionReady=null;
      let openChatWindows={};
      let offset=270;
      let selectedGroupId=null, selectedGroupName=null;
      let unreadMessages={};
      const CACHE_LIMIT=200, MAX_FILES=10, MAX_SIZE_MB=50;

      /* ======= Helpers ======= */
      const sanitizeHTML = (str)=>{ if(!str) return ''; const d=document.createElement('div'); d.textContent=str; return d.innerHTML; };

      const isImageUrl = u => /\.(png|jpe?g|webp|gif)$/i.test(u||'');
      const isDocxUrl = u => /\.docx?$/i.test(u||'');
      const isPdfUrl  = u => /\.pdf$/i.test(u||'');
      const isAudioUrl= u => /\.(mp3|wav|ogg|m4a)$/i.test(u||'');
      const isVideoUrl= u => /\.(mp4|webm|m4v|mov)$/i.test(u||'');

      function getFileIcon(url){
        if(isImageUrl(url)) return '';
        if(isVideoUrl(url)) return '🎬';
        if(isAudioUrl(url)) return '';
        if(isPdfUrl(url))  return '📄';
        if(isDocxUrl(url)) return '📝';
        return '📎';
      }
        function buildAttachmentBlock(url/*, canOptions */) {
        let fileName = (url || '').split('/').pop() || 'tệp đính kèm';
        const icon = getFileIcon(url);

        // Rút gọn tên file nếu dài quá 20 ký tự
        const maxLength = 20;
        if (fileName.length > maxLength) {
            const ext = fileName.includes('.') ? '.' + fileName.split('.').pop() : '';
            const baseName = fileName.replace(ext, '');
            fileName = baseName.substring(0, maxLength - ext.length - 3) + '...' + ext;
        }

        if (isImageUrl(url)) {
            return `
                <div class="attach" data-url="${url}">
                    <img src="${url}" alt="image">
                </div>`;
        }
        if (isVideoUrl(url)) {
            return `
                <div class="attach" data-url="${url}">
                    <video src="${url}" controls playsinline></video>
                </div>`;
        }
        if (isAudioUrl(url)) {
            return `
                <div class="attach" data-url="${url}" style="width: 210px; height: auto;">
                    <div class="meta">${sanitizeHTML(fileName)}</div>
                    <audio src="${url}" controls></audio>
                </div>`;
        }
        return `
            <div class="attach" data-url="${url}">
                <span class="icon">${icon}</span>
                <div class="meta">${sanitizeHTML(fileName)}</div>
            </div>`;
    }



      async function uploadFileAndGetUrl(file){
        const form=new FormData(); form.append('file', file);
        const res=await fetch('/File/UploadFromBrowser', { method:'POST', body:form });
        if(!res.ok){ const txt=await res.text(); throw new Error(`Upload thất bại: ${txt}`); }
        const json=await res.json(); return json.url;
      }
      async function uploadManyAndGetUrls(files){ return Promise.all(files.map(f=>uploadFileAndGetUrl(f))); }

      function saveUserDisplayNamesToCache(users){ try{const dict={};(users||[]).forEach(u=>{dict[u.username]=u.displayName||u.username;});localStorage.setItem('userDisplayNames',JSON.stringify(dict));}catch{} }
      function getUserDisplayNameFromCache(username){ try{const s=localStorage.getItem('userDisplayNames');if(!s) return username;const m=JSON.parse(s);return m[username]||username;}catch{return username;} }
      async function getUserDisplayName(username){
        const cached=getUserDisplayNameFromCache(username);
        if (cached!==username) return cached;
        try{
          const res=await $.ajax({url:'/chat/getAllEx',method:'GET'});
          if(res.data){ saveUserDisplayNamesToCache(res.data); const u=res.data.find(x=>x.username===username); return u?(u.displayName||u.username):username; }
          return username;
        }catch{ return username; }
      }

      function saveGroupNamesToCache(groups){ try{const dict={};(groups||[]).forEach(g=>{dict[g.grouP_ID]=g.grouP_NAME;});localStorage.setItem('groupNames',JSON.stringify(dict));}catch{} }
      function getGroupNameFromCache(id){ try{const s=localStorage.getItem('groupNames'); if(!s) return null; const d=JSON.parse(s); return d[id]||null;}catch{return null;} }
      async function getGroupName(id){
        const c=getGroupNameFromCache(id); if(c) return c;
        try{
          const res=await $.ajax({url:'/chat/GetGroupUser',method:'GET'});
          if(res.data){ saveGroupNamesToCache(res.data); const g=res.data.find(x=>x.grouP_ID===id); return g?g.grouP_NAME:`Group ${id}`; }
          return `Group ${id}`;
        }catch{ return `Group ${id}`; }
      }

      function loadUnreadMessages(){ try{ const s=localStorage.getItem('unreadMessages'); if(s) unreadMessages=JSON.parse(s)||{}; }catch{} }
      function saveUnreadMessages(){ try{ localStorage.setItem('unreadMessages', JSON.stringify(unreadMessages)); }catch{} }

      /* ======= Danh sách ======= */
      function loadUsers(){
        const userList=document.getElementById('userList');
        userList.innerHTML='<li class="header">🔸 Người dùng</li>';
        $.ajax({
          url:'/chat/getAllEx', method:'GET',
          success:data=>{
            userList.innerHTML='<li class="header">🔸 Người dùng</li>';
            (data.data||[]).forEach(user=>{
              const li=document.createElement('li');
              const key=`user:${user.username}`; const unread=unreadMessages[key]||0;
              const displayName=user.displayName||user.username;
              li.innerHTML=`<span>${sanitizeHTML(displayName)}</span>${unread>0?`<span class="unread-count">${unread}</span>`:''}`;
              li.onclick=()=>{
                openNewChatWindow('user', user.username, displayName);
                unreadMessages[key]=0; saveUnreadMessages(); updateUserList(); saveChatState();
              };
              userList.appendChild(li);
            });
            saveUserDisplayNamesToCache(data.data||[]); saveChatState();
          },
          error:()=>{
            userList.innerHTML='<li class="header">🔸 Người dùng</li><li style="color:red;">Lỗi khi tải dữ liệu!</li>';
            saveChatState();
          }
        });
      }

      function loadGroups(){
        const groupList=document.getElementById('groupList');
        groupList.innerHTML='<li class="header">👥 Nhóm</li>';
        $.ajax({
          url:'/chat/GetGroupUser', method:'GET',
          success:data=>{
            groupList.innerHTML='<li class="header">👥 Nhóm</li>';
            document.getElementById('show-members-btn').style.display='none';
            document.getElementById('groupMembersList').style.display='none';
            (data.data||[]).forEach(group=>{
              const li=document.createElement('li');
              const key=`group:${group.grouP_ID}`; const unread=unreadMessages[key]||0;
              li.innerHTML=`<span>${sanitizeHTML(group.grouP_NAME)}</span>${unread>0?`<span class="unread-count">${unread}</span>`:''}`;
              li.onclick=()=>{
                selectedGroupId=group.grouP_ID; selectedGroupName=group.grouP_NAME;
                document.getElementById('show-members-btn').style.display='block';
                openNewChatWindow('group', group.grouP_ID, group.grouP_NAME);
                unreadMessages[key]=0; saveUnreadMessages(); updateGroupList(); saveChatState();
              };
              groupList.appendChild(li);
            });
            saveGroupNamesToCache(data.data||[]); saveChatState();
          },
          error:()=>{
            groupList.innerHTML='<li class="header">👥 Nhóm</li><li style="color:red;">Lỗi khi tải dữ liệu!</li>';
            saveChatState();
          }
        });
      }

      function updateUserList(){
        const userList=document.getElementById('userList');
        const header=userList.querySelector('.header');
        $.ajax({
          url:'/chat/getAllEx', method:'GET',
          success:data=>{
            userList.innerHTML=''; userList.appendChild(header);
            (data.data||[]).forEach(user=>{
              const li=document.createElement('li');
              const key=`user:${user.username}`; const unread=unreadMessages[key]||0;
              const displayName=user.displayName||user.username;
              li.innerHTML=`<span>${sanitizeHTML(displayName)}</span>${unread>0?`<span class="unread-count">${unread}</span>`:''}`;
              li.onclick=()=>{
                openNewChatWindow('user', user.username, displayName);
                unreadMessages[key]=0; saveUnreadMessages(); updateUserList(); saveChatState();
              };
              userList.appendChild(li);
            });
          }
        });
      }

      function updateGroupList(){
        const groupList=document.getElementById('groupList');
        const header=groupList.querySelector('.header');
        $.ajax({
          url:'/chat/GetGroupUser', method:'GET',
          success:data=>{
            groupList.innerHTML=''; groupList.appendChild(header);
            (data.data||[]).forEach(group=>{
              const li=document.createElement('li');
              const key=`group:${group.grouP_ID}`; const unread=unreadMessages[key]||0;
              li.innerHTML=`<span>${sanitizeHTML(group.grouP_NAME)}</span>${unread>0?`<span class="unread-count">${unread}</span>`:''}`;
              li.onclick=()=>{
                selectedGroupId=group.grouP_ID; selectedGroupName=group.grouP_NAME;
                openNewChatWindow('group', group.grouP_ID, group.grouP_NAME);
                unreadMessages[key]=0; saveUnreadMessages(); updateGroupList(); saveChatState();
              };
              groupList.appendChild(li);
            });
          }
        });
      }

      function loadGroupMembers(){
        if(!selectedGroupId){ alert('❗ Vui lòng chọn nhóm trước!'); return; }
        const list=document.getElementById('groupMembersList');
        list.innerHTML='<li class="header">👤 Danh sách thành viên :</li>';
        $.ajax({
          url:'/chat/GetGroupMembers', method:'POST', contentType:'application/json', data: JSON.stringify({ groupId: selectedGroupId }),
          success:data=>{
            list.innerHTML=`<li class="header">👤 Danh sách thành viên : ${sanitizeHTML(selectedGroupName||'')}</li>`;
            (data.data||[]).forEach(m=>{
              const li=document.createElement('li');
              const name=m.displayName||m.username;
              li.innerHTML=`<span>${sanitizeHTML(name)}</span><button>Xóa</button>`;
              li.querySelector('button').onclick=()=>removeMemberFromGroup(m.username);
              list.appendChild(li);
            });
            list.style.display = (list.style.display==='block' ? 'none' : 'block');
            saveChatState();
          },
          error: ()=>{
            list.innerHTML='<li class="header">👤 Thành viên nhóm</li><li style="color:red;">Lỗi khi tải dữ liệu!</li>';
            saveChatState();
          }
        });
      }

      function addUserToGroup(){
        const username=document.getElementById('add-user-to-group').value.trim();
        if(!username){ alert('⚠️ Vui lòng nhập tên người dùng!'); return; }
        if(!selectedGroupId){ alert('⚠️ Vui lòng chọn một nhóm trước!'); return; }
        $.ajax({
          url:'/chat/AddUserToGroup', method:'POST', contentType:'application/json',
          data: JSON.stringify({ groupId: selectedGroupId, username }),
          success:r=>{
            if(r.success){ alert(`✅ Đã thêm ${sanitizeHTML(username)} vào nhóm!`); document.getElementById('add-user-to-group').value=''; loadGroupMembers(); }
            else { alert(`❌ Lỗi: ${sanitizeHTML(r.message||'Không thể thêm người dùng vào nhóm!')}`); }
            saveChatState();
          },
          error:()=>{ alert('❌ Đã xảy ra lỗi khi thêm người dùng vào nhóm!'); saveChatState(); }
        });
      }

      function removeMemberFromGroup(username){
        if(!selectedGroupId){ alert('❗ Vui lòng chọn nhóm trước khi xóa!'); return; }
        if(!confirm(`Bạn có chắc muốn xóa ${sanitizeHTML(username)} khỏi nhóm?`)) return;
        $.ajax({
          url:'/chat/RemoveGroupMembers', method:'POST', contentType:'application/json',
          data: JSON.stringify({ groupId: selectedGroupId, username }),
          success:r=>{
            if(r.success){ alert('✅ Đã xóa thành viên!'); loadGroupMembers(); }
            else { alert(`❌ Xóa thất bại: ${sanitizeHTML(r.message||'Lỗi không xác định')}`); }
            saveChatState();
          },
          error:()=>{ alert('❌ Đã xảy ra lỗi khi xóa thành viên!'); saveChatState(); }
        });
      }

      /* ======= Lưu/khôi phục ======= */
      function saveChatState(){
        const chatState={ openChatWindows:{}, offset, selectedGroupId,
          panelVisible: document.getElementById('user-list-panel')?.style.display==='block',
          activeTab: document.getElementById('tab-users')?.classList.contains('active')?'users':'groups',
          createGroupName: document.getElementById('create-group-name')?.value||'',
          groupOptionsVisible: document.getElementById('group-options')?.style.display!=='none'
        };
        Object.keys(openChatWindows).forEach(key=>{
          const chatBox=document.getElementById(`chat-${key}`); if(!chatBox) return;
          const temp=document.createElement('div'); temp.innerHTML=chatBox.innerHTML;
          const limited=Array.from(temp.children).slice(-200).map(n=>n.outerHTML).join('');
          const headerSpan=openChatWindows[key].querySelector('.chat-header span');
          if(headerSpan){
            chatState.openChatWindows[key]={
              type:key.split(':')[0], id:key.split(':')[1], displayName:headerSpan.textContent,
              messages:limited, isMinimized: openChatWindows[key].classList.contains('min')
            };
          }
        });
        try{ localStorage.setItem('chatState', JSON.stringify(chatState)); }catch{}
      }

      function restoreChatState(){
        let st; try{ st=JSON.parse(localStorage.getItem('chatState')); }catch{ return; }
        if(!st || typeof st!=='object') return;
        if(!st.openChatWindows || typeof st.openChatWindows!=='object') st.openChatWindows={};

        const panel=document.getElementById('user-list-panel');
        if(panel) panel.style.display=st.panelVisible?'block':'none';

        const usersContent=document.getElementById('users-content');
        const groupsContent=document.getElementById('groups-content');
        const tabUsers=document.getElementById('tab-users');
        const tabGroups=document.getElementById('tab-groups');
        const groupOptions=document.getElementById('group-options');

        if(st.activeTab==='users'){
          if(usersContent) usersContent.style.display='block';
          if(groupsContent) groupsContent.style.display='none';
          if(tabUsers) tabUsers.classList.add('active');
          if(tabGroups) tabGroups.classList.remove('active');
        }else{
          if(usersContent) usersContent.style.display='none';
          if(groupsContent) groupsContent.style.display='block';
          if(tabUsers) tabUsers.classList.remove('active');
          if(tabGroups) tabGroups.classList.add('active');
        }

        if(st.createGroupName) document.getElementById('create-group-name').value=st.createGroupName;
        if(groupOptions){
          groupOptions.style.display=st.groupOptionsVisible?'block':'none';
          const t=document.getElementById('toggle-group-options');
          if(t) t.textContent=st.groupOptionsVisible?'Ẩn tùy chọn nhóm':'Hiện tùy chọn nhóm';
        }

        offset=st.offset||270; selectedGroupId=st.selectedGroupId;

        Object.keys(st.openChatWindows).forEach(key=>{
          const {type,id,displayName,messages,isMinimized}=st.openChatWindows[key];
          openNewChatWindow(type, id, displayName, true);
          const chatBox=document.getElementById(`chat-${key}`);
          if(chatBox) chatBox.innerHTML=messages;
          if(isMinimized && openChatWindows[key]) openChatWindows[key].classList.add('min');
        });

        if(st.panelVisible){ loadUsers(); loadGroups(); startSignalR(); }

        Object.keys(st.openChatWindows).forEach(key=>{
          const w=st.openChatWindows[key];
          if(w.type==='user'){ loadChatHistory(w.id, key); }
          else {
            const doLoad=()=>loadGroupHistory(w.id, key);
            if(connectionReady && typeof connectionReady.then==='function'){ connectionReady.then(doLoad).catch(()=>{}); }
            else { startSignalR().then(doLoad).catch(()=>{}); }
          }
        });
      }

      function saveMessagesToCache(type,id,messages){
        try{ const k=`chat_${type}:${id}`; localStorage.setItem(k, JSON.stringify(messages.slice(-CACHE_LIMIT))); }catch{}
      }
      function loadMessagesFromCache(type,id){
        try{ const k=`chat_${type}:${id}`; const s=localStorage.getItem(k); if(!s) return []; const arr=JSON.parse(s); return Array.isArray(arr)?arr:[]; }catch{ return []; }
      }

      /* ======= Cửa sổ chat ======= */
      async function openNewChatWindow(type, id, displayName=null, isRestoring=false){
        const key=`${type}:${id}`;
        if (openChatWindows[key]){
          openChatWindows[key].style.display='block';
          openChatWindows[key].classList.remove('min');
          unreadMessages[key]=0; saveUnreadMessages(); updateUserList(); updateGroupList();
          if(!isRestoring) saveChatState();
          return;
        }

        let finalDisplayName=displayName;
        if(type==='user' && !displayName) finalDisplayName=await getUserDisplayName(id);

        const wrapper=document.createElement('div');
        wrapper.id=`chat-window-${key}`; wrapper.className='chat-window';
        wrapper.style.right=`${offset+40}px`; wrapper.style.zIndex=10000+offset;
        wrapper.displayName=finalDisplayName||id;

        /* header */
        const header=document.createElement('div');
        header.className='chat-header';
        header.innerHTML=`
          <span>${sanitizeHTML(finalDisplayName||id)}</span>
          <div>
            <button class="minimize-btn" title="Thu nhỏ">-</button>
            <button class="close-btn" title="Đóng">×</button>
          </div>`;
        header.querySelector('.close-btn').onclick=()=>{
          document.body.removeChild(wrapper); delete openChatWindows[key];
          offset-=300; repositionChatWindows(); saveChatState();
        };
        header.querySelector('.minimize-btn').onclick=()=>{
          wrapper.classList.toggle('min'); saveChatState();
        };

        /* chat box */
        const chatBox=document.createElement('div');
        chatBox.id=`chat-${key}`; chatBox.className='chat-box';
        chatBox.dataset.chatType = type;   // 'user' | 'group'
        chatBox.dataset.chatId   = id;     // receiver username OR groupId

        /* footer */
        const footer=document.createElement('div'); footer.className='chat-footer';

        const chipRow=document.createElement('div'); chipRow.className='chip-row';

        const attachBtn=document.createElement('button'); attachBtn.type='button'; attachBtn.title='Đính kèm tệp'; attachBtn.textContent='📎'; attachBtn.className='attach-btn';
        const fileInput=document.createElement('input'); fileInput.type='file'; fileInput.style.display='none'; fileInput.multiple=true;
        fileInput.accept='.png,.jpg,.jpeg,.webp,.gif,.pdf,.doc,.docx,.mp3,.wav,.ogg,.m4a,.mp4,.webm,.m4v,.mov';

        const input=document.createElement('input'); input.type='text'; input.placeholder='Nhập tin nhắn...';
        const sendBtn=document.createElement('button'); sendBtn.textContent='Gửi';

        const controlsRow=document.createElement('div'); controlsRow.className='controls-row';
        controlsRow.appendChild(attachBtn);
        controlsRow.appendChild(fileInput);
        controlsRow.appendChild(input);
        controlsRow.appendChild(sendBtn);

        // Drag & drop
        ;[chatBox, chipRow].forEach(el=>{
          el.addEventListener('dragover', e=>{ e.preventDefault(); el.style.background='#eef2ff'; });
          el.addEventListener('dragleave', ()=>{ el.style.background=''; });
          el.addEventListener('drop', e=>{
            e.preventDefault(); el.style.background='';
            if(!e.dataTransfer?.files?.length) return;
            addFiles([...(e.dataTransfer.files)]);
          });
        });

        // file state
        let selectedFiles=[];
        function clearAllChips(){
          chipRow.innerHTML=''; chipRow.style.display='none';
          selectedFiles.forEach(x=>{ if(x.previewUrl) URL.revokeObjectURL(x.previewUrl); });
          selectedFiles=[]; fileInput.value='';
        }
        function removeOneChip(idChip){
          const idx=selectedFiles.findIndex(x=>x.id===idChip);
          if(idx>=0){ const x=selectedFiles[idx]; if(x.previewUrl) URL.revokeObjectURL(x.previewUrl); selectedFiles.splice(idx,1); }
          renderChips();
        }
        function addFiles(files){
          if(!files || !files.length) return;
          const remain=MAX_FILES - selectedFiles.length;
          const pick=[...files].slice(0, remain);
          for(const f of pick){
            if((f.size/1024/1024) > MAX_SIZE_MB){ alert(`⚠️ ${f.name} vượt quá ${MAX_SIZE_MB}MB, bỏ qua.`); continue; }
            const item={ file:f, id:`${Date.now()}_${Math.random().toString(36).slice(2)}` };
            if (f.type.startsWith('image/')) item.previewUrl=URL.createObjectURL(f);
            item.icon=getFileIcon(f.name);
            selectedFiles.push(item);
          }
          renderChips();
        }
        function renderChips(){
          chipRow.innerHTML='';
          if(selectedFiles.length===0){ chipRow.style.display='none'; return; }
          selectedFiles.forEach(x=>{
            const chip=document.createElement('div'); chip.className='chip';
            if(x.previewUrl){ const img=document.createElement('img'); img.src=x.previewUrl; img.alt='preview'; chip.appendChild(img); }
            else{ const icon=document.createElement('span'); icon.className='icon'; icon.textContent=x.icon; chip.appendChild(icon); }
            const name=document.createElement('span'); name.className='name'; name.textContent=x.file.name;
            const remove=document.createElement('button'); remove.className='remove'; remove.textContent='×';
            remove.addEventListener('click',()=>removeOneChip(x.id));
            chip.appendChild(name); chip.appendChild(remove);
            chipRow.appendChild(chip);
          });
          chipRow.style.display='flex';
        }

        attachBtn.addEventListener('click', ()=>fileInput.click());
        fileInput.addEventListener('change', ()=> addFiles([...(fileInput.files||[])]) );

        async function sendMessage(){
          const message=input.value.trim();
          if(!message && selectedFiles.length===0){
            alert('⚠️ Vui lòng nhập tin nhắn hoặc chọn tệp!');
            return;
          }
          const messageId=`${currentUser}_${new Date().toISOString()}_${Math.random().toString(36).substr(2,9)}`;
          try{
            if(!connection || connection.state!==signalR.HubConnectionState.Connected){ await startSignalR(); }

            let attachmentUrls=[];
            if(selectedFiles.length>0){
              const urls=await uploadManyAndGetUrls(selectedFiles.map(x=>x.file));
              attachmentUrls=urls;
            }

            if(type==='user'){
              await connection.invoke('SendMessage', {
                SenderUsername: currentUser,
                ReceiverUsername: id,
                MessageText: message,
                AttachmentUrls: attachmentUrls,
                Timestamp: new Date().toISOString(),
                MessageId: messageId
              });
            }else{
              await connection.invoke('SendMessage', {
                SenderUsername: currentUser,
                GroupId: id,
                MessageText: message,
                AttachmentUrls: attachmentUrls,
                Timestamp: new Date().toISOString(),
                MessageId: messageId
              });
            }

            input.value=''; clearAllChips();
            chatBox.scrollTop = chatBox.scrollHeight;
          }catch(err){
            console.error('Send error:', err);
            alert(err?.message || 'Gửi tin nhắn thất bại');
          }
          saveChatState();
        }

        input.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });
        sendBtn.addEventListener('click', sendMessage);

        footer.appendChild(chipRow);
        footer.appendChild(controlsRow);
        wrapper.appendChild(header);
        wrapper.appendChild(chatBox);
        wrapper.appendChild(footer);
        document.body.appendChild(wrapper);
        openChatWindows[key]=wrapper;
        offset+=300; repositionChatWindows();

        if(!isRestoring){
          if(type==='user'){ loadChatHistory(id, key); }
          else{
            const doLoad=()=>loadGroupHistory(id, key);
            if(connectionReady && typeof connectionReady.then==='function'){ connectionReady.then(doLoad).catch(()=>{}); }
            else { startSignalR().then(doLoad).catch(()=>{}); }
          }
        }
        saveChatState();
      }

      function repositionChatWindows(){
        let x=270;
        Object.values(openChatWindows).forEach(w=>{ w.style.right=`${x+40}px`; x+=310; });
        offset=x; saveChatState();
      }

      /* ======= RENDER 1 MESSAGE ======= */
           function appendMessage(containerId, sender, text, timestamp, messageId, attachmentUrls) {
      if (!text && (!attachmentUrls || attachmentUrls.length === 0)) return;
      const container = document.getElementById(containerId); if (!container) return;

      const timeStr = timestamp
        ? (isNaN(new Date(timestamp)) ? '' : new Date(timestamp).toLocaleTimeString())
        : new Date().toLocaleTimeString();

      const isMine = sender === currentUser;

      const ctxKey = containerId.replace('chat-', '');
      let receiverUsername = '', groupId = '';
      if (ctxKey.startsWith('user:')) receiverUsername = (ctxKey.split(':')[1] || '');
      else if (ctxKey.startsWith('group:')) groupId = (ctxKey.split(':')[1] || '');

      const msg = document.createElement('div');
      msg.className = `chat-message ${isMine ? 'sent' : 'received'}`;
      msg.dataset.messageId = messageId || '';
      msg.dataset.isMine = isMine ? '1' : '0';
      msg.dataset.peer = receiverUsername;
      msg.dataset.groupId = groupId;

      let html = '';

      // ==== TEXT ====
      if (text) {
        if (isMine) {
          // MÌNH GỬI: có nút ⋯ và dùng flex để đặt nút cạnh bubble
          html += `
            <div class="bubble-row" style="display:flex;flex-direction:row-reverse;gap:6px;align-items:flex-start;">
              <div class="message-content">${sanitizeHTML(text)}</div>
              <button class="options-btn" type="button" aria-label="Tùy chọn" data-kind="text" data-mid="${messageId||''}">⋯</button>
            </div>
          `;
        } else {
          // NGƯỜI KHÁC: KHÔNG dùng flex, chỉ render bubble thuần
          html += `<div class="message-content">${sanitizeHTML(text)}</div>`;
        }
      }

      // ==== ATTACHMENTS (giữ flex cho cả hai phía để nút ⋯ nằm cạnh) ====
          if (attachmentUrls && attachmentUrls.length > 0) {
      html += attachmentUrls
        .map(u => buildAttachmentRow(u, isMine, messageId))
        .join('');
    }

      html += `<div class="timestamp"><strong>${sanitizeHTML(sender)}</strong> </div>`;

      msg.innerHTML = html;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
    }
        function buildAttachmentRow(url, isMine, messageId){
      return `
        <div class="attach-row" style="display:flex;${isMine ? 'flex-direction:row-reverse;' : ''}gap:6px;align-items:flex-start;margin-top:6px;">
          ${buildAttachmentBlock(url)}
          <button class="options-btn" type="button" aria-label="Tùy chọn tệp" data-kind="file" data-mid="${messageId||''}">⋯</button>
        </div>`;
    }



      /* ======= Chuẩn hoá tin vào ======= */
      function normalizeIncoming(msg){
        const sender = msg.SenderUsername ?? msg.senderUsername ?? '';
        const receiver = msg.ReceiverUsername ?? msg.receiverUsername ?? '';
        const groupId = msg.GroupId ?? msg.groupId ?? '';
        const messageText = msg.MessageText ?? msg.messageText ?? '';
        const ts = msg.Timestamp ?? msg.timestamp ?? '';
        const mid = msg.MessageId ?? msg.messageId ?? '';
        let atts = msg.AttachmentUrls ?? msg.attachmentUrls ?? null;
        if(!Array.isArray(atts)){
          const single = msg.AttachmentUrl ?? msg.attachmentUrl ?? null;
          atts = single ? [single] : [];
        }
        return { sender, receiver, groupId, messageText, ts, mid, atts };
      }

      function loadChatHistory(user, key){
        const chatBox=document.getElementById(`chat-${key}`); if(!chatBox) return;
        const cached=loadMessagesFromCache('user', user);
        if(cached.length>0){
          chatBox.innerHTML='';
          cached.forEach(m=>{
            const txt = m.MessageText ?? m.messageText ?? '';
            const arr = (m.AttachmentUrls ?? m.attachmentUrls) || ((m.AttachmentUrl ?? m.attachmentUrl) ? [m.AttachmentUrl ?? m.attachmentUrl] : []);
            appendMessage(`chat-${key}`, m.SenderUsername ?? m.senderUsername, txt, m.Timestamp ?? m.timestamp, m.MessageId ?? m.messageId, arr);
          });
        }else{
          chatBox.innerHTML='<div>Đang tải...</div>';
        }
        $.ajax({
          url:'/chat/GetChatBetweenUsers', method:'POST', contentType:'application/json',
          data: JSON.stringify({ usename1: currentUser, usename2: user }),
          success:r=>{
            chatBox.innerHTML='';
            if(r.success){
              const messages=r.data||[];
              saveMessagesToCache('user', user, messages);
              messages.forEach(m=>{
                const txt = m.MessageText ?? m.messageText ?? '';
                const arr = (m.AttachmentUrls ?? m.attachmentUrls) || ((m.AttachmentUrl ?? m.attachmentUrl) ? [m.AttachmentUrl ?? m.attachmentUrl] : []);
                appendMessage(`chat-${key}`, m.SenderUsername ?? m.senderUsername, txt, m.Timestamp ?? m.timestamp, m.MessageId ?? m.messageId, arr);
              });
              if(messages.length===0 && cached.length===0){
                chatBox.innerHTML='<div>Chưa có tin nhắn nào</div>';
              }
            }else{
              chatBox.innerHTML=`<div style="color:red;">Lỗi: ${sanitizeHTML(r.message||'Không thể tải tin nhắn')}</div>`;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
            saveChatState();
          },
          error: ()=>{
            if(cached.length===0) chatBox.innerHTML='<div style="color:red;">Lỗi khi tải lịch sử chat!</div>';
            saveChatState();
          }
        });
      }

      function loadGroupHistory(groupId, key){
        const chatBox=document.getElementById(`chat-${key}`); if(!chatBox) return;
        const cached=loadMessagesFromCache('group', groupId);
        if(cached.length>0){
          chatBox.innerHTML='';
          cached.forEach(m=>{
            const txt = m.MessageText ?? m.messageText ?? '';
            const arr = (m.AttachmentUrls ?? m.attachmentUrls) || ((m.AttachmentUrl ?? m.attachmentUrl) ? [m.AttachmentUrl ?? m.attachmentUrl] : []);
            appendMessage(`chat-${key}`, m.SenderUsername ?? m.senderUsername, txt, m.Timestamp ?? m.timestamp, m.MessageId ?? m.messageId, arr);
          });
        }else{
          chatBox.innerHTML='<div>Đang tải...</div>';
        }

        const joinAndLoad=()=>{
          connection.invoke('JoinGroup', groupId).then(()=>{
            $.ajax({
              url:'/chat/getMessagesinGroup', method:'POST', contentType:'application/json',
              data: JSON.stringify({ username: currentUser, groupId }),
              success:r=>{
                chatBox.innerHTML='';
                if(r.success){
                  const messages=r.data||[];
                  saveMessagesToCache('group', groupId, messages);
                  messages.forEach(m=>{
                    const txt = m.MessageText ?? m.messageText ?? '';
                    const arr = (m.AttachmentUrls ?? m.attachmentUrls) || ((m.AttachmentUrl ?? m.attachmentUrl) ? [m.AttachmentUrl ?? m.attachmentUrl] : []);
                    appendMessage(`chat-${key}`, m.SenderUsername ?? m.senderUsername, txt, m.Timestamp ?? m.timestamp, m.MessageId ?? m.messageId, arr);
                  });
                  if(messages.length===0 && cached.length===0){
                    chatBox.innerHTML='<div>Chưa có tin nhắn nào trong nhóm này</div>';
                  }
                }else{
                  if(cached.length===0){
                    chatBox.innerHTML=`<div style="color:red;">Lỗi: ${sanitizeHTML(r.message||'Không thể tải tin nhắn nhóm')}</div>`;
                  }
                }
                chatBox.scrollTop = chatBox.scrollHeight;
                saveChatState();
              },
              error: ()=>{
                if(cached.length===0) chatBox.innerHTML='<div style="color:red;">Lỗi khi tải lịch sử nhóm</div>';
                saveChatState();
              }
            });
          }).catch(err=>{
            if(cached.length===0) chatBox.innerHTML=`<div style="color:red;">Lỗi khi tham gia nhóm: ${sanitizeHTML(err.message)}</div>`;
            saveChatState();
          });
        };

        if(!connection || connection.state!==signalR.HubConnectionState.Connected){
          startSignalR().then(joinAndLoad).catch(err=>{
            if(cached.length===0) chatBox.innerHTML=`<div style="color:red;">Lỗi khi kết nối SignalR: ${sanitizeHTML(err.message)}</div>`;
            saveChatState();
          });
        } else { joinAndLoad(); }
      }

      /* ======= SignalR ======= */
      async function startSignalR(){
        if(connection && connection.state===signalR.HubConnectionState.Connected) return;
        connection = new signalR.HubConnectionBuilder()
          .withUrl('/chathub?username='+encodeURIComponent(currentUser))
          .withAutomaticReconnect([0,1000,5000,10000]).build();

        connection.on('ReceiveMessage', async raw=>{
          const m = normalizeIncoming(raw);
          const key = m.groupId
            ? `group:${m.groupId}`
            : (m.sender===currentUser ? `user:${m.receiver}` : `user:${m.sender}`);

          if (!openChatWindows[key]){
            const name = m.groupId
              ? await getGroupName(m.groupId)
              : (openChatWindows[key]?.displayName || await getUserDisplayName(m.sender===currentUser?m.receiver:m.sender));
            openNewChatWindow(m.groupId?'group':'user', m.groupId || (m.sender===currentUser?m.receiver:m.sender), name);
          }

          appendMessage(`chat-${key}`, m.sender, m.messageText, m.ts, m.mid, m.atts);
        });

        // server thông báo xoá
        connection.on('MessageDeleted', (messageId) => {
          const els=document.querySelectorAll(`.chat-message[data-message-id="${messageId}"]`);
          els.forEach(el=>el.remove());
          saveChatState();
        });

        connectionReady = connection.start();
        await connectionReady;
      }

      /* ======= Side panel (menu) ======= */
      let currentPanel=null, panelCloser=null;
      const PANEL_WIDTH=200, GUTTER=8;

      function closeSidePanel(){
        if(currentPanel){
          currentPanel.remove();
          currentPanel=null;
        }
        if(panelCloser){
          document.removeEventListener('click', panelCloser, true);
          window.removeEventListener('resize', closeSidePanel, true);
          window.removeEventListener('scroll', closeSidePanel, true);
          document.removeEventListener('keydown', escCloser, true);
          panelCloser=null;
        }
      }
      function escCloser(e){ if(e.key==='Escape') closeSidePanel(); }

      function openSidePanel(btn, side, items){
           closeSidePanel();

    const panel=document.createElement('div');
    panel.className='sidepanel '+(side==='right'?'right':'left');
    const ul=document.createElement('ul');
    items.forEach(it=>{
      const li=document.createElement('li');
      if (it.disabled) li.classList.add('disabled');   // <<-- mới
      const i=document.createElement('span'); i.className='i'; i.textContent=it.icon||'•';
      const t=document.createElement('span'); t.textContent=it.label;
      li.appendChild(i); li.appendChild(t);
      li.addEventListener('click', (e)=>{
        e.stopPropagation();
        if (it.disabled) return;                       // <<-- chặn click nếu disable
        it.action();
        closeSidePanel();
      });
      ul.appendChild(li);
    });
    panel.appendChild(ul);
    document.body.appendChild(panel);

        const r=btn.getBoundingClientRect();
        const top = window.scrollY + r.top - 6;
        let left;
        if (side==='right'){ left = window.scrollX + r.right + GUTTER; }
        else { left = window.scrollX + r.left - PANEL_WIDTH - GUTTER; }
        panel.style.top = `${top}px`;
        panel.style.left= `${left}px`;
        panel.style.width= PANEL_WIDTH+'px';

        requestAnimationFrame(()=> panel.classList.add('show') );

        panelCloser=(ev)=>{
          if (!panel.contains(ev.target) && ev.target!==btn){
            closeSidePanel();
          }
        };
        setTimeout(()=>{
          document.addEventListener('click', panelCloser, true);
          window.addEventListener('resize', closeSidePanel, true);
          window.addEventListener('scroll', closeSidePanel, true);
          document.addEventListener('keydown', escCloser, true);
        },0);

        currentPanel=panel;
      }

      function deleteMessage(mid, contextEl){
        if(!mid) return;
        if(!confirm('Bạn có chắc chắn muốn xóa tin nhắn này không?')) return;

        // Lấy context chat (user / group) để gọi đúng tham số hub
        const chatBox = contextEl.closest('.chat-box');
        const chatType = chatBox?.dataset.chatType || '';
        const chatId   = chatBox?.dataset.chatId   || '';
        const receiverUsername = (chatType==='user') ? chatId : '';
        const groupId  = (chatType==='group') ? chatId : '';

        connection.invoke('DeleteMessage', mid, receiverUsername, groupId).catch(err=>{
          console.error('Delete error:', err);
          alert('Xóa tin nhắn thất bại');
        });
      }

      // click nút ⋯ (nằm ngoài bubble/attach)
         document.addEventListener('click', function(e){
      if (!e.target.classList.contains('options-btn')) return;
      e.stopPropagation();

      const btn   = e.target;
      const kind  = btn.getAttribute('data-kind'); // 'text' | 'file'
      const mid   = btn.getAttribute('data-mid') || '';
      const msgEl = btn.closest('.chat-message');
      const isMine = msgEl?.dataset.isMine === '1';
      const groupId = msgEl?.dataset.groupId || '';
      const peer    = msgEl?.dataset.peer || '';
      const side = msgEl?.classList.contains('received') ? 'right' : 'left';

      // MENU ITEMS
      let items = [];

      if (kind === 'text') {
        // Text: chỉ có nút khi là của mình -> chỉ cần 'Xóa'
        items = [
          { icon:'🗑️', label:'Xóa', disabled:false, action: ()=>{
              if (!confirm('Bạn có chắc chắn muốn xóa tin nhắn này?')) return;
              connection.invoke('DeleteMessage', mid, peer, groupId).catch(err=>{
                console.error('Delete error:', err);
                alert('Xóa tin nhắn thất bại');
              });
            }
          }
        ];
      } else {
        // File: luôn hiện menu cho cả hai phía
        // Hành động Xóa: disable khi KHÔNG phải của mình
        items.push({
          icon:'🗑️', label:'Xóa',
          disabled: !isMine,
          action: ()=>{
            if (!isMine) return; // đề phòng
            if (!confirm('Bạn có chắc chắn muốn xóa tệp/tin nhắn này?')) return;
            connection.invoke('DeleteMessage', mid, peer, groupId).catch(err=>{
              console.error('Delete error:', err);
              alert('Xóa tin nhắn thất bại');
            });
          }
        });

        // Lấy URL từ block gần nhất
        const attach = btn.parentElement.querySelector('.attach');
        const url = attach?.getAttribute('data-url') || '';
        const name = attach?.querySelector('.meta')?.textContent || 'file';

        if (url) {
          if (isPdfUrl(url)) {
            items.push({ icon:'👁️', label:'Xem PDF', action: ()=> window.open(url,'_blank') });
          } else if (isDocxUrl(url)) {
            const viewer='https://view.officeapps.live.com/op/view.aspx?src='+encodeURIComponent(url);
            items.push({ icon:'👁️', label:'Xem DOCX', action: ()=> window.open(viewer,'_blank') });
            items.push({ icon:'↗️', label:'Mở file gốc', action: ()=> window.open(url,'_blank') });
          } else {
            items.push({ icon:'↗️', label:'Mở', action: ()=> window.open(url,'_blank') });
          }
          items.push({
            icon:'⬇️', label:'Tải xuống',
            action: ()=>{
              const a=document.createElement('a'); a.href=url; a.download=name;
              document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
          });
          items.push({ icon:'🔗', label:'Copy link', action: ()=> navigator.clipboard?.writeText(url) });
        }
      }

      openSidePanel(btn, side, items);
    });


      /* ======= Boot & Panel events ======= */
      document.addEventListener('DOMContentLoaded', ()=>{
        if(!window.chatSignalRInitialized){ window.chatSignalRInitialized=true; startSignalR().catch(console.error); }
        loadUnreadMessages(); restoreChatState();
      });

      document.getElementById('toggle-chat')?.addEventListener('click', ()=>{
        const panel=document.getElementById('user-list-panel');
        panel.style.display = panel.style.display==='none' ? 'block' : 'none';
        if (panel.style.display==='block'){ loadUsers(); loadGroups(); startSignalR(); }
        saveChatState();
      });
      document.getElementById('close-list')?.addEventListener('click', ()=>{
        const panel=document.getElementById('user-list-panel');
        panel.style.display='none'; selectedGroupId=null;
        const showBtn=document.getElementById('show-members-btn'); if(showBtn) showBtn.style.display='none';
        saveChatState();
      });
      document.getElementById('tab-users')?.addEventListener('click', ()=>{
        document.getElementById('users-content').style.display='block';
        document.getElementById('groups-content').style.display='none';
        document.getElementById('tab-users').classList.add('active');
        document.getElementById('tab-groups').classList.remove('active');
        selectedGroupId=null; document.getElementById('show-members-btn').style.display='none';
        saveChatState();
      });
      document.getElementById('tab-groups')?.addEventListener('click', ()=>{
        document.getElementById('users-content').style.display='none';
        document.getElementById('groups-content').style.display='block';
        document.getElementById('tab-users').classList.remove('active');
        document.getElementById('tab-groups').classList.add('active');
        saveChatState();
      });
      document.getElementById('create-group-btn')?.addEventListener('click', ()=>createNewGroup());
      document.getElementById('create-group-name')?.addEventListener('keypress', e=>{ if(e.key==='Enter') createNewGroup(); });
      document.getElementById('add-user-btn')?.addEventListener('click', ()=>addUserToGroup());
      document.getElementById('add-user-to-group')?.addEventListener('keypress', e=>{ if(e.key==='Enter') addUserToGroup(); });
      document.getElementById('show-members-btn')?.addEventListener('click', ()=>loadGroupMembers());

      function createNewGroup(){
        const groupName=document.getElementById('create-group-name').value.trim();
        if(!groupName){ alert('❗ Vui lòng nhập tên nhóm!'); return; }
        $.ajax({
          url:'/chat/createGroupwithCreator', method:'POST', contentType:'application/json',
          data:JSON.stringify({ groupName, username: currentUser }),
          success:r=>{
            if(r.success){ alert(`✅ Tạo nhóm ${sanitizeHTML(groupName)} thành công!`); document.getElementById('create-group-name').value=''; loadGroups(); saveChatState(); }
            else { alert(`❌ Tạo nhóm thất bại: ${sanitizeHTML(r.message||'Lỗi không xác định')}`); }
          },
          error:()=>alert('❌ Đã xảy ra lỗi khi tạo nhóm!')
        });
      }

      // expose nhẹ
      window.loadUsers=loadUsers; window.loadGroups=loadGroups;
    })();
</script>
