@{
    ViewData["Title"] = "Quản lý quyền người dùng";
}

<h2 class="mt-4 mb-3">Phân quyền người dùng</h2>

<div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Username</th>
                <th>Quyền hiện tại</th>
                <th>Chọn quyền mới</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="userPermissionTable">
            <!-- Dữ liệu sẽ được render bằng JS -->
        </tbody>
    </table>
</div>

<!-- Modal hiển thị danh sách quyền -->
<div class="modal fade" id="permissionModal" tabindex="-1" aria-labelledby="permissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="permissionModalLabel">Danh sách quyền</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body" id="permissionList">
                <!-- Nội dung danh sách quyền -->
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let allPermissions = [];
    let currentUserPermissions = {};

    $(document).ready(function () {
        $.get('/Account/getall', function (res) {
            console.log("GET /Account/getall result:", res);
            if (res.code === 200) {
                allPermissions = res.data;
                loadUsersWithPermissions();
            } else {
                alert("Không thể tải danh sách quyền: " + res.message);
            }
        });
    });

    function loadUsersWithPermissions() {
        $.get('/Account/getuser', function (res) {
            console.log("GET /Account/getuser result:", res);
            if (res.code === 200) {
                const users = res.data;
                const tableBody = $('#userPermissionTable');
                tableBody.empty();

                const grouped = {};
                users.forEach(item => {
                    if (!grouped[item.username]) grouped[item.username] = [];
                    grouped[item.username].push(item.permission_Code);
                });

                currentUserPermissions = grouped;

                Object.keys(grouped).forEach(username => {
                    const currentPermissions = grouped[username] || [];
                    const dropdownOptions = allPermissions.map(p => `
                        <option value="${p.permission_Code}">${p.permission_Code}</option>
                    `).join("");

                    const row = `
                        <tr>
                            <td>${username}</td>
                            <td>
                                <button class="btn btn-info btn-sm" onclick="showPermissions('${username}')">
                                    Xem (${currentPermissions.length})
                                </button>
                            </td>
                            <td>
                                <select class="form-select" id="select-${username}">
                                    ${dropdownOptions}
                                </select>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="updatePermission('${username}')">Thêm quyền</button>
                            </td>
                        </tr>
                    `;
                    tableBody.append(row);
                });
            } else {
                alert("Không thể tải người dùng: " + res.message);
            }
        });
    }

    function showPermissions(username) {
        const permissions = currentUserPermissions[username] || [];
        const container = $('#permissionList');
        container.empty();

        if (permissions.length === 0) {
            container.append(`<p>Không có quyền nào.</p>`);
        } else {
            permissions.forEach(p => {
                const item = $(`
                    <div class="d-flex justify-content-between align-items-center border p-2 mb-2 rounded bg-light">
                        <span>${p}</span>
                        <button class="btn btn-danger btn-sm" onclick="removePermission('${username}', '${p}')">Gỡ</button>
                    </div>
                `);
                container.append(item);
            });
        }

        const modal = new bootstrap.Modal(document.getElementById('permissionModal'));
        modal.show();
    }

    function updatePermission(username) {
        const newPermission = $(`#select-${username}`).val();
        const payload = {
            username: username,
            Permission_Code: newPermission
        };

        console.log("Sending updatePermission payload:", payload);

        $.ajax({
            url: '/Account/updateUserPermission',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (res) {
                console.log("Response from updateUserPermission:", res);

                if (res.code === "200" || res.success === true) {
                    alert(res.message || "Cập nhật thành công!");
                    loadUsersWithPermissions();
                    }else if (res.code === "403") {
                    alert("Không có quyền cập nhật!");
                }
                    else {
                    alert("Cập nhật thất bại: " + (res.message || "Không rõ lỗi"));
                }
            },
            error: function (xhr, status, err) {
                console.error("Error calling updateUserPermission:", xhr.responseText || err);
                alert("Lỗi khi gửi yêu cầu cập nhật quyền.");
            }
        });
    }

    function removePermission(username, permission_Code) {
        if (!confirm(`Bạn có chắc muốn gỡ quyền "${permission_Code}" cho user "${username}"?`)) return;

        const payload = {
            username,
            Permission_Code: permission_Code
        };

        console.debug("Sending removePermission payload:", payload);

        $.ajax({
            url: '/Account/DeleteUserPermission',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (res) {
                console.debug("Response from remove-user-permission:", res);

                if (res.code === "200" || res.success === true) {
                    alert(res.message || "Đã gỡ quyền!");
                    loadUsersWithPermissions();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('permissionModal'));
                    modal.hide();
                }
                    else if (res.code === "403") {
                        alert("Không có quyền cập nhật!");
                    }
                else {
                    alert("Gỡ quyền thất bại: " + (res.message || "Không rõ lỗi"));
                }
            },
            error: function (xhr, status, err) {
                console.error("Error calling remove-user-permission:", xhr.responseText || err);
                alert("Lỗi khi gửi yêu cầu gỡ quyền.");
            }
        });
    }
</script>
