@{
    ViewData["Title"] = "Danh sách phòng ban";
}

<!-- jQuery + Bootstrap -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<style>
    #loading {
        display: none;
        text-align: center;
        margin: 20px;
    }
</style>

@await Html.PartialAsync("_AlertMessage")

<div class="container mt-4">
    <h3 class="mb-3">Quản lý phòng ban</h3>

    <div class="form-inline mb-3">
        <input type="number" class="form-control mr-2" id="searchIdInput" placeholder="Nhập mã phòng cần tìm" />
        <button class="btn btn-primary mr-2" id="searchBtn">Tìm phòng</button>
        <button class="btn btn-secondary" id="resetBtn">Reset</button>
    </div>

    <div id="loading" class="alert alert-info">Đang tải dữ liệu...</div>

    <table id="departmentTable" class="table table-bordered table-striped">
        <thead class="thead-dark">
            <tr>
                <th>Mã phòng</th>
                <th>Tên phòng</th>
                <th>Trưởng phòng</th>
                <th>Ngày nhận chức</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    $(document).ready(function () {

        function showLoading(show) {
            $("#loading").toggle(show);
        }

        function showMessage(message) {
            $('#departmentTable tbody').html(`<tr><td colspan="4" class="text-center text-danger">${message}</td></tr>`);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getDate().toString().padStart(2, '0')}/` +
                   `${(date.getMonth() + 1).toString().padStart(2, '0')}/` +
                   `${date.getFullYear()}`;
        }

        function renderTable(data) {
            const rows = data.map(item => `
                <tr>
                    <td>${item.maphg}</td>
                    <td>${item.tenphg}</td>
                    <td>${item.trphg}</td>
                    <td>${formatDate(item.nG_NHANCHUC)}</td>
                </tr>
            `);
            $('#departmentTable tbody').html(rows.join(''));
        }

        function handleError(jqXHR, action) {
            const resp = jqXHR.responseJSON;
            if (resp && resp.message) {
                showMessage(resp.message);
            } else if (jqXHR.status === 403) {
                showMessage("Bạn không có quyền " + action + ".");
            } else if (jqXHR.status === 401) {
                showMessage("Bạn chưa đăng nhập. Vui lòng đăng nhập lại.");
            } else {
                showMessage("Lỗi khi " + action + ": " + jqXHR.status);
            }
        }

        function loadAllDepartments() {
            showLoading(true);
            $.getJSON('/dept/getalldataset')
                .done(function (response) {
                    showLoading(false);
                    if (response.success && Array.isArray(response.data)) {
                        renderTable(response.data);
                    } else {
                        const msg = response.message || "Không có dữ liệu hoặc bạn không có quyền truy cập.";
                        showMessage(msg);
                    }
                })
                .fail(function (jqXHR) {
                    showLoading(false);
                    handleError(jqXHR, "tải danh sách phòng");
                });
        }

        function searchDepartmentById(id) {
            showLoading(true);
            $.ajax({
                url: '/dept/GetByIdDataSet?id=' + id,
                type: 'GET'
            })
            .done(function (response) {
                showLoading(false);
                if (response.success && response.data.length > 0) {
                    renderTable(response.data);
                } else {
                    const msg = response.message || ("Không tìm thấy phòng ban với mã: " + id);
                    showMessage(msg);
                }
            })
            .fail(function (jqXHR) {
                showLoading(false);
                handleError(jqXHR, "tìm phòng");
            });
        }

        $('#searchBtn').click(function () {
            const id = $('#searchIdInput').val();
            if (!id) {
                alert("Vui lòng nhập mã phòng.");
                return;
            }
            searchDepartmentById(id);
        });

        $('#resetBtn').click(function () {
            $('#searchIdInput').val('');
            loadAllDepartments();
        });

        loadAllDepartments();
    });
</script>
